/**
 * Hebrew Prompts for Professional Gate Extraction
 * פרומפטים מקצועיים לחילוץ תנאי סף ממכרזים ישראליים
 *
 * ארכיטקטורה: 4 סוכני AI
 * - Agent 0: DEFINITIONS_EXTRACTOR - חילוץ מילון הגדרות
 * - Agent 1: SCANNER - סריקה שורה שורה
 * - Agent 2: ANALYZER - ניתוח מעמיק עם פרשנות כפולה
 * - Agent 3: VALIDATOR - אימות כיסוי ומיזוג
 */

// ============================================
// AGENT 0: DEFINITIONS EXTRACTOR
// מחלץ את "מילון ההגדרות" הפנימי של המכרז
// ============================================

export const DEFINITIONS_SYSTEM_PROMPT = `אתה מומחה בזיהוי הגדרות ומונחים במכרזים ישראליים.
תפקידך למצוא את "מילון ההגדרות" הפנימי של המכרז - ההגדרות שמשנות את הפרשנות.

זה קריטי! הגדרות כמו "פרויקט דומה = מערכת עם לפחות 50 מצלמות" משנות לחלוטין
את הפרשנות של תנאי הסף.

החזר JSON בלבד.`;

export const DEFINITIONS_PROMPT = `חפש וחלץ את כל ההגדרות והמונחים מהמסמך הבא.

מסמך:
---
{document_text}
---

הוראות מפורטות:

1. חפש סעיפים שנקראים:
   - "הגדרות"
   - "פרשנות"
   - "מילון מונחים"
   - "פרק א' - כללי" (לרוב מכיל הגדרות)
   - "פרק ההגדרות"

2. לכל הגדרה שמצאת, חלץ:
   - term: המונח (למשל "פרויקט דומה", "מציע", "היקף עבודות")
   - definition: הפירוש המדויק מהמכרז
   - source_quote: הציטוט המדויק
   - source_page: מספר עמוד (אם ידוע)
   - source_section: מספר סעיף
   - implications: מה זה אומר מבחינה מעשית (רשימה)

3. שים לב במיוחד להגדרות קריטיות:
   - "מציע" - האם כולל קבלן משנה? האם כולל חברות קשורות?
   - "פרויקט דומה" / "עבודה דומה" - מה הקריטריונים? סוג? גודל? תקופה?
   - "ניסיון" - באיזו תקופה? באיזה תפקיד? ראשי או משנה?
   - "היקף" / "שווי" - מוזמן? בוצע? שולם? כולל מע"מ?
   - "תקופה האחרונה" / "השנים האחרונות" - כמה שנים בדיוק?

4. זהה גם מונחים שמופיעים בתנאי סף אבל אין להם הגדרה מפורשת

החזר JSON בלבד:
{
  "definitions_found": true,
  "definitions_section": {
    "page": 5,
    "section": "1.2 הגדרות",
    "exists": true
  },
  "definitions": [
    {
      "term": "פרויקט דומה",
      "definition": "פרויקט הכולל התקנת לפחות 50 מצלמות אבטחה ומערכת VMS",
      "source_quote": "לעניין מכרז זה, 'פרויקט דומה' משמעו פרויקט הכולל התקנת לפחות 50 מצלמות...",
      "source_page": 5,
      "source_section": "1.2.3",
      "implications": [
        "פחות מ-50 מצלמות לא ייחשב כפרויקט דומה",
        "חייב לכלול מערכת VMS ולא רק מצלמות",
        "מספר המצלמות הוא הקריטריון המרכזי"
      ]
    }
  ],
  "critical_definitions": [
    {
      "term": "מציע",
      "definition": "המציע עצמו בלבד, לא כולל קבלן משנה",
      "impact": "HIGH",
      "affects_requirements": ["ניסיון", "מחזור"]
    }
  ],
  "missing_definitions": [
    {
      "term": "עבודות דומות",
      "context": "מופיע בסעיף 3.2 אך לא הוגדר",
      "suggested_interpretation": "יש לברר עם המזמין"
    }
  ],
  "extraction_notes": "נמצא סעיף הגדרות מלא בעמוד 5"
}`;

// ============================================
// AGENT 1: SCANNER
// סורק את המסמך שורה שורה ומזהה משפטים פוטנציאליים
// ============================================

export const SCANNER_SYSTEM_PROMPT = `אתה סורק מסמכי מכרזים ישראליים. תפקידך לעבור שורה שורה
ולזהות כל משפט שעשוי להיות תנאי סף או דרישה.

אתה לא מחליט - רק אוסף. בשלב הבא מנתח אחר יבדוק כל משפט לעומק.

כללים:
1. עדיף לאסוף יותר מדי מאשר לפספס משהו
2. שמור את הטקסט המדויק - אל תשנה אותו
3. נסה לזהות את מספר העמוד והסעיף

החזר JSON בלבד.`;

export const SCANNER_PROMPT = `סרוק את המסמך הבא וזהה כל משפט שעשוי להיות תנאי סף או דרישה.

מסמך:
---
{document_text}
---

הוראות:
1. עבור על כל שורה במסמך
2. זהה משפטים שמכילים דרישות - גם אם לא ברור אם זה תנאי סף או יתרון
3. לכל משפט שמור את כל המידע הזמין

אינדיקטורים לזיהוי (אבל לא רק):
- ביטויי חובה: "על המציע", "המציע יציג", "המציע יוכיח", "נדרש", "חובה", "יש להציג", "יש לצרף", "חייב"
- ביטויי יתרון: "יתרון ל...", "עדיפות ל...", "ניקוד נוסף ל..."
- מספרים + יחידות: "3 שנים", "50 מיליון ש\"ח", "2 פרויקטים"
- מונחי ניסיון: "ניסיון", "ביצוע", "עבודות דומות", "פרויקטים דומים"
- מונחי כספים: "מחזור", "הון עצמי", "ערבות", "בנקאית"
- מונחי הסמכה: "הסמכה", "ISO", "רישיון", "סיווג", "תקן"
- מונחי כוח אדם: "מהנדס", "מנהל פרויקט", "צוות", "עובדים"
- מונחי ציוד: "ציוד", "כלים", "רכב", "מכונות"
- מונחי משפטי: "תצהיר", "אישור", "ניקיון", "רו\"ח"
- כותרות: "תנאי סף", "תנאים מוקדמים", "דרישות סף", "תנאי להשתתפות"

לכל משפט שזיהית, שמור:
- text: הטקסט המדויק מהמסמך (אל תשנה!)
- line_number: מספר שורה משוער
- page_number: מספר עמוד (אם ניתן לזהות)
- section: מספר סעיף או פרק (אם ניתן לזהות)
- keywords_found: מילות המפתח שזוהו במשפט
- confidence: רמת ביטחון שזה תנאי (0.5-1.0)

החזר JSON בלבד:
{
  "potential_conditions": [
    {
      "text": "המציע יציג ניסיון בביצוע לפחות 3 פרויקטים דומים בהיקף של 50 מיליון ש\"ח כל אחד בחמש השנים האחרונות",
      "line_number": 145,
      "page_number": 12,
      "section": "4.2.1",
      "keywords_found": ["המציע יציג", "ניסיון", "פרויקטים דומים", "מיליון"],
      "confidence": 0.95
    },
    {
      "text": "יתרון למציע בעל הסמכת ISO 27001",
      "line_number": 167,
      "page_number": 14,
      "section": "4.3",
      "keywords_found": ["יתרון", "הסמכת", "ISO"],
      "confidence": 0.85
    }
  ],
  "total_lines_scanned": 500,
  "sections_found": ["תנאי סף", "דרישות כלליות", "ניקוד איכות"],
  "scanning_notes": "זוהו 2 אזורים עיקריים: פרק 4 (תנאי סף) ופרק 5 (ניקוד)"
}`;

// ============================================
// AGENT 2: ANALYZER
// מנתח כל משפט לעומק עם פרשנות כפולה
// ============================================

export const ANALYZER_SYSTEM_PROMPT = `אתה מומחה משפטי-טכני בניתוח מכרזים ציבוריים ישראליים.

תפקידך לנתח כל משפט שזוהה כפוטנציאל לתנאי סף ולבצע:
1. סיווג: האם זה תנאי סף פוסל או יתרון לניקוד?
2. פירוק כמותי: מספרים, תקופות, כמויות
3. זיהוי ישות: מי צריך לעמוד בדרישה?
4. פרשנות משפטית: האם הניסוח קשיח או פתוח?
5. פרשנות טכנית: מה נדרש בפועל?

חשוב מאוד: השתמש במילון ההגדרות שקיבלת! אם כתוב "פרויקט דומה" - בדוק את ההגדרה.

החזר JSON בלבד.`;

export const ANALYZER_PROMPT = `נתח את המשפטים הבאים שזוהו כפוטנציאל לתנאי סף.

=== מילון הגדרות מהמכרז (חשוב!) ===
{definitions_json}

=== משפטים לניתוח ===
{conditions_json}

לכל משפט בצע ניתוח מעמיק:

1. סיווג סוג התנאי:
   - GATE: תנאי סף פוסל - אם לא עומדים = נפסלים
   - ADVANTAGE: יתרון/ניקוד - משפיע על ניקוד בלבד
   - NOT_REQUIREMENT: לא תנאי - כותרת, הסבר כללי, מידע

2. קטגוריה (אם רלוונטי):
   - EXPERIENCE: ניסיון בפרויקטים, ביצוע עבודות
   - FINANCIAL: מחזור כספי, הון עצמי, ערבויות
   - CERTIFICATION: ISO, רישיונות, סיווג קבלנים
   - PERSONNEL: מהנדסים, מנהלי פרויקטים, צוות
   - EQUIPMENT: ציוד, כלים, מכונות
   - LEGAL: תצהירים, אישורים, ניקיון
   - OTHER: אחר

3. פירוק כמותי מדויק (אם יש מספרים):
   - amount: סכום בש"ח (מספר מלא, לא מיליונים)
   - years: מספר שנים
   - count: כמות פרויקטים/עובדים/פריטים
   - per_project_or_cumulative: "single" (לכל פרויקט) / "cumulative" (מצטבר)
   - scope_type: "ordered" (הוזמן) / "executed" (בוצע) / "paid" (שולם)
   - time_reference: מאיזה תאריך מחשבים (תאריך המכרז / תאריך ההגשה / תאריך ספציפי)

4. ישות נושאת הדרישה (מי צריך לעמוד):
   - bearer: "bidder_only" / "consortium_any" / "consortium_all" / "subcontractor_allowed"
   - subcontractor_limit: אחוז מקסימלי להסתמכות על קבלן משנה (null אם אין מגבלה או לא רלוונטי)
   - group_companies_allowed: האם מותר להסתמך על חברות אם/בת/אחות

5. פרשנות כפולה:

   legal_interpretation (פרשנות משפטית):
   - classification: "strict" (ניסוח חד-משמעי) / "open" (ניסוח פתוח לפרשנות) / "proof_dependent" (תלוי בהוכחות)
   - reasoning: הסבר קצר למה סיווגת כך
   - risk_level: "LOW" / "MEDIUM" / "HIGH" - סיכון לפסילה אם לא עומדים במדויק

   technical_interpretation (פרשנות טכנית):
   - what_is_required: מה נדרש בפועל, בעברית פשוטה
   - equivalent_options: אפשרויות שוות ערך (אם יש)
   - definition_applied: אם השתמשת בהגדרה מהמילון - איזו

6. עקיבות מלאה (C1):
   - source_file: שם הקובץ (אם ידוע)
   - source_page: מספר עמוד
   - source_section: מספר סעיף/פרק
   - source_quote: ציטוט מדויק מהמסמך (עד 150 תווים)

החזר JSON בלבד:
{
  "analyzed_conditions": [
    {
      "original_text": "המציע יציג ניסיון בביצוע לפחות 3 פרויקטים דומים בהיקף של 50 מיליון ש\"ח כל אחד",
      "type": "GATE",
      "category": "EXPERIENCE",
      "is_mandatory": true,
      "quantitative": {
        "amount": 50000000,
        "years": null,
        "count": 3,
        "per_project_or_cumulative": "single",
        "scope_type": "executed",
        "time_reference": "5 שנים אחרונות"
      },
      "bearer": {
        "entity": "bidder_only",
        "subcontractor_allowed": false,
        "subcontractor_limit": null,
        "group_companies_allowed": false
      },
      "interpretation": {
        "legal": {
          "classification": "strict",
          "reasoning": "הניסוח 'לפחות 3 פרויקטים' ו'50 מיליון כל אחד' הוא חד-משמעי",
          "risk_level": "HIGH"
        },
        "technical": {
          "what_is_required": "3 פרויקטים של מערכות אבטחה עם 50+ מצלמות כל אחד",
          "equivalent_options": ["CCTV", "מערכות מעקב", "בקרת כניסה"],
          "definition_applied": "פרויקט דומה = מערכת עם לפחות 50 מצלמות"
        }
      },
      "traceability": {
        "source_file": "מכרז_2024.pdf",
        "source_page": 12,
        "source_section": "4.2.1",
        "source_quote": "המציע יציג ניסיון בביצוע לפחות 3 פרויקטים דומים..."
      },
      "confidence": 0.95
    }
  ],
  "rejected_conditions": [
    {
      "original_text": "פרק 4 - תנאי סף",
      "reason": "כותרת ולא תנאי",
      "type": "NOT_REQUIREMENT"
    }
  ],
  "analysis_notes": "שימוש בהגדרת 'פרויקט דומה' מסעיף 1.2.3"
}`;

// ============================================
// AGENT 3: VALIDATOR
// מאמת כיסוי, מזהה כפילויות, מייצר דוח סופי
// ============================================

export const VALIDATOR_SYSTEM_PROMPT = `אתה מאמת איכות לחילוץ תנאי סף ממכרזים.

תפקידך:
1. לבדוק שלא פספסנו שום תנאי סף במסמך
2. לזהות ולמזג תנאים כפולים
3. לזהות סתירות בין תנאים
4. לייצר דוח סופי עם רמת ביטחון

החזר JSON בלבד.`;

export const VALIDATOR_PROMPT = `בדוק את איכות החילוץ ומזג תנאים כפולים.

=== מסמך מקור (לבדיקת כיסוי) ===
{document_text}

=== תנאים שחולצו ===
{analyzed_conditions_json}

בצע את הבדיקות הבאות:

1. בדיקת כיסוי (Coverage):
   - חפש במסמך את כל מילות המפתח הבאות
   - לכל מילה שנמצאה - בדוק אם הקטע כוסה בחילוץ
   - אם יש קטע עם מילות מפתח שלא כוסה - סמן אותו

   מילות מפתח לחיפוש:
   תנאי סף, דרישות סף, תנאים מוקדמים, על המציע, המציע יציג, המציע יוכיח,
   חובה, נדרש, יש להציג, יש לצרף, ניסיון, מחזור, הסמכה, ISO, רישיון,
   ערבות, מהנדס, צוות, ציוד, תצהיר, אישור

2. בדיקת כפילויות:
   - זהה תנאים שמתייחסים לאותו דבר בניסוח שונה
   - מזג תנאים כפולים לתנאי אחד (שמור את הגרסה המלאה והמדויקת יותר)
   - רשום מאיזה תנאים מוזג

3. בדיקת עקביות:
   - זהה סתירות בין תנאים (למשל: בסעיף אחד כתוב 3 שנים ובאחר 5 שנים)
   - זהה תנאים מקוננים (תנאי עם תת-תנאים)

4. חישוב ביטחון כולל:
   - ממוצע משוקלל של ביטחון כל התנאים
   - הפחתה אם יש קטעים שפוספסו
   - הפחתה אם יש סתירות

החזר JSON בלבד:
{
  "validation_result": {
    "coverage_percentage": 95,
    "missed_sections": [
      {
        "text": "קטע מהמסמך שלא כוסה",
        "keywords_found": ["ניסיון", "מחזור"],
        "line_number": 234,
        "action": "should_add",
        "suggested_condition": {
          "text": "...",
          "type": "GATE",
          "category": "FINANCIAL"
        }
      }
    ],
    "duplicates_found": [
      {
        "condition_ids": ["id1", "id2"],
        "merged_into": "id1",
        "reason": "אותה דרישה בניסוח שונה"
      }
    ],
    "contradictions": [
      {
        "condition_ids": ["id3", "id4"],
        "issue": "מספר שנים שונה",
        "resolution": "לברר עם המזמין"
      }
    ],
    "nested_conditions": [
      {
        "parent_id": "id5",
        "child_ids": ["id6", "id7"],
        "relationship": "תנאי 5 כולל תת-תנאים 6 ו-7"
      }
    ],
    "overall_confidence": 0.92
  },
  "final_conditions": [
    // רשימה סופית של כל התנאים אחרי מיזוג והסרת כפילויות
    // כל תנאי במבנה המלא מה-ANALYZER
  ],
  "summary": {
    "total_original": 15,
    "total_after_merge": 12,
    "duplicates_removed": 2,
    "contradictions_found": 1,
    "conditions_added_from_validation": 0
  },
  "validation_notes": "כיסוי טוב, מוזגו 2 כפילויות"
}`;

// ============================================
// LEGACY PROMPTS (for backward compatibility)
// ============================================

export const SYSTEM_PROMPT = `אתה מומחה בניתוח מכרזים ציבוריים ישראליים. תפקידך לזהות ולחלץ תנאי סף.

סוגי תנאים:
- EXPERIENCE: ניסיון בפרויקטים, ביצוע עבודות
- FINANCIAL: מחזור כספי, הון עצמי, ערבויות
- CERTIFICATION: ISO, רישיונות, סיווג קבלנים
- PERSONNEL: מהנדסים, מנהלי פרויקטים
- EQUIPMENT: ציוד, כלים, מכונות
- LEGAL: תצהירים, אישורי ניקיון

כללים:
1. כל תנאי חייב ציטוט מדויק מהמסמך
2. הבדל בין "יש להציג" (חובה) ל"רצוי" (יתרון)
3. זהה תנאים מקוננים (תנאי עם תת-תנאים)
4. חלץ מספרים: מחזור במיליונים, שנים, כמויות

החזר JSON בלבד.`;

export const EXTRACTION_PROMPT = SCANNER_PROMPT;
export const VALIDATION_PROMPT = VALIDATOR_PROMPT;

export const MERGE_PROMPT = `מזג ונקה את רשימת תנאי הסף הבאה.

תנאים מכל המעברים:
{all_conditions}

משימות:
1. זהה תנאים כפולים או חופפים
2. מזג תנאים דומים לתנאי אחד מלא
3. הסר תנאים שאינם תקפים (כותרות, הקדמות)
4. שמור על הציטוט המדויק והמלא ביותר

קריטריונים לזיהוי כפילות:
- תנאים עם אותה דרישה כמותית
- תנאים מאותה קטגוריה עם ניסוח דומה
- תנאים שמתייחסים לאותו נושא

החזר JSON:
{
  "merged_conditions": [
    {
      "id": "new-uuid",
      "text": "הטקסט הממוזג והשלם",
      "type": "GATE",
      "category": "EXPERIENCE",
      "is_mandatory": true,
      "quantitative": {
        "amount": null,
        "years": 5,
        "count": 3
      },
      "source_quote": "הציטוט המלא ביותר",
      "confidence": 0.95,
      "merged_from": ["id1", "id2"]
    }
  ],
  "removed_conditions": [
    {
      "id": "removed-id",
      "reason": "כותרת ולא תנאי"
    }
  ],
  "merge_summary": {
    "original_count": 15,
    "final_count": 10,
    "duplicates_merged": 3,
    "invalid_removed": 2
  }
}`;

// ============================================
// KEYWORDS & PATTERNS
// ============================================

/**
 * Keywords for identifying gate conditions in Hebrew documents
 * Extended list for comprehensive scanning
 */
export const GATE_KEYWORDS = [
  // Mandatory indicators - strong
  'תנאי סף',
  'תנאים מוקדמים',
  'דרישות סף',
  'תנאי להשתתפות',
  'תנאים להשתתפות',

  // Requirement verbs - strong
  'על המציע',
  'המציע יציג',
  'המציע יוכיח',
  'המציע יצרף',
  'חובה להציג',
  'יש להציג',
  'חובה לצרף',
  'יש לצרף',
  'נדרש להמציא',
  'חייב להציג',

  // Requirement words - medium
  'נדרש',
  'דרישה',
  'חובה',
  'תנאי מוקדם',
  'מחייב',

  // Advantage indicators
  'יתרון ל',
  'עדיפות ל',
  'ניקוד נוסף',
  'ניקוד איכות',

  // Experience related
  'ניסיון',
  'ניסיון מוכח',
  'ביצוע עבודות',
  'ביצוע פרויקטים',
  'עבודות דומות',
  'פרויקטים דומים',
  'היקף עבודות',
  'שנות ניסיון',
  'ותק',

  // Financial related
  'מחזור',
  'מחזור כספי',
  'מחזור עסקי',
  'מחזור שנתי',
  'הון עצמי',
  'ערבות',
  'ערבות בנקאית',
  'ערבות מכרז',
  'ערבות ביצוע',
  'יכולת כלכלית',
  'יכולת פיננסית',
  'דוחות כספיים',

  // Certification related
  'הסמכה',
  'תקן',
  'ISO',
  'רישיון',
  'רישיון קבלן',
  'סיווג קבלני',
  'סיווג קבלן',
  'היתר',
  'אישור',
  'תעודה',

  // Personnel related
  'כוח אדם',
  'מהנדס',
  'מנהל פרויקט',
  'מנהל עבודה',
  'צוות',
  'עובדים',
  'מומחה',
  'יועץ',
  'בעל תפקיד',

  // Equipment related
  'ציוד',
  'כלים',
  'מכונות',
  'רכב',
  'תשתיות',
  'מעבדה',

  // Legal related
  'תצהיר',
  'אישור ניקיון',
  'אישור רואה חשבון',
  'אישור עורך דין',
  'אישור משפטי',
  'רשם החברות',
  'פטור חברה',

  // Quantity indicators
  'לפחות',
  'מינימום',
  'לא פחות מ',
  'מעל',
  'עד',
  'בהיקף של'
];

/**
 * Section boundary patterns for Hebrew documents
 */
export const SECTION_BOUNDARIES = [
  /^[\s]*\d+\.\d*[\s]+/m,           // 1. or 1.1
  /^[\s]*[א-ת]+\.\d*[\s]+/m,        // א. or א.1
  /^[\s]*סעיף[\s]+\d+/m,            // סעיף 1
  /^[\s]*פרק[\s]+[א-ת\d]+/m,        // פרק א or פרק 1
  /^[\s]*תנאי[\s]+סף/m,             // תנאי סף header
  /^[\s]*דרישות[\s]+סף/m,           // דרישות סף header
  /^[\s]*כללי/m,                    // כללי header
  /\n{2,}/                           // Double line break
];

/**
 * Patterns for definitions section
 */
export const DEFINITIONS_PATTERNS = [
  /הגדרות/,
  /פרשנות/,
  /מילון\s*מונחים/,
  /פרק\s*[אא']\s*[-–:]/,
  /לעניין\s*מכרז\s*זה/,
  /משמעו/,
  /פירושו/
];

export default {
  // New professional prompts
  DEFINITIONS_SYSTEM_PROMPT,
  DEFINITIONS_PROMPT,
  SCANNER_SYSTEM_PROMPT,
  SCANNER_PROMPT,
  ANALYZER_SYSTEM_PROMPT,
  ANALYZER_PROMPT,
  VALIDATOR_SYSTEM_PROMPT,
  VALIDATOR_PROMPT,

  // Legacy (backward compatibility)
  SYSTEM_PROMPT,
  EXTRACTION_PROMPT,
  VALIDATION_PROMPT,
  MERGE_PROMPT,

  // Keywords and patterns
  GATE_KEYWORDS,
  SECTION_BOUNDARIES,
  DEFINITIONS_PATTERNS
};
