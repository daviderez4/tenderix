<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenderix - ×œ×•×— ×‘×§×¨×”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.95);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 24px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
        }

        .sidebar-logo {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 8px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            color: rgba(255,255,255,0.6);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s;
            font-size: 15px;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
        }

        .sidebar-nav a.active {
            background: linear-gradient(135deg, rgba(96,165,250,0.2) 0%, rgba(167,139,250,0.2) 100%);
            border: 1px solid rgba(96,165,250,0.3);
        }

        .sidebar-user {
            position: absolute;
            bottom: 24px;
            left: 24px;
            right: 24px;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-user:hover {
            background: rgba(255,255,255,0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            color: #f1f5f9;
        }

        .user-email {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-right: 280px;
            padding: 32px;
        }

        /* Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .header-title h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #f1f5f9 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header-title p {
            color: rgba(255,255,255,0.5);
            font-size: 15px;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e2e8f0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }

        @media (max-width: 1400px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .main-content { margin-right: 0; padding: 16px; }
            .sidebar { display: none; }
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 28px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            background: rgba(255,255,255,0.08);
            border-color: rgba(96,165,250,0.3);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-icon.blue { background: rgba(59, 130, 246, 0.2); }
        .stat-icon.green { background: rgba(34, 197, 94, 0.2); }
        .stat-icon.yellow { background: rgba(234, 179, 8, 0.2); }
        .stat-icon.purple { background: rgba(139, 92, 246, 0.2); }

        .stat-value {
            font-size: 40px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .stat-label {
            color: rgba(255,255,255,0.5);
            font-size: 14px;
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .content-grid { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .card-body {
            padding: 24px;
        }

        /* Tender List */
        .tender-list {
            list-style: none;
        }

        .tender-item {
            display: flex;
            align-items: center;
            padding: 20px;
            margin-bottom: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .tender-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(96,165,250,0.3);
            transform: translateX(-4px);
        }

        .tender-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 16px;
        }

        .tender-status.active { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .tender-status.pending { background: #eab308; box-shadow: 0 0 10px #eab308; }
        .tender-status.analyzing { background: #06b6d4; box-shadow: 0 0 10px #06b6d4; }
        .tender-status.draft { background: #64748b; }

        .tender-info {
            flex: 1;
        }

        .tender-name {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .tender-meta {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
        }

        .tender-value {
            text-align: left;
        }

        .tender-amount {
            font-weight: 700;
            color: #22c55e;
            font-size: 16px;
        }

        .tender-deadline {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 4px;
        }

        .tender-deadline.urgent {
            color: #f87171;
        }

        /* Activity List */
        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(59,130,246,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .activity-text {
            color: #e2e8f0;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .activity-time {
            color: rgba(255,255,255,0.4);
            font-size: 12px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: rgba(255,255,255,0.5);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
            margin-bottom: 12px;
            color: #e2e8f0;
        }

        .empty-state-subtext {
            font-size: 14px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 24px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Upload Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #f1f5f9;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(239,68,68,0.2);
            color: #f87171;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed rgba(96,165,250,0.3);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(59,130,246,0.05);
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: #60a5fa;
            background: rgba(59,130,246,0.1);
        }

        .upload-zone-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-zone-text {
            font-size: 18px;
            color: #e2e8f0;
            margin-bottom: 12px;
        }

        .upload-zone-hint {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
        }

        .upload-progress {
            text-align: center;
        }

        .upload-progress .spinner {
            margin: 0 auto 20px;
        }

        .upload-progress p {
            color: #60a5fa;
            font-size: 16px;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #f1f5f9;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255,255,255,0.08);
        }

        .form-input::placeholder {
            color: rgba(255,255,255,0.3);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }

        .toast.success { border-color: rgba(34,197,94,0.3); }
        .toast.error { border-color: rgba(239,68,68,0.3); }
        .toast.info { border-color: rgba(59,130,246,0.3); }

        .toast-icon {
            font-size: 24px;
        }

        .toast-message {
            flex: 1;
            color: #e2e8f0;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* File input hidden */
        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">Tenderix</div>
            <nav>
                <ul class="sidebar-nav">
                    <li><a href="tenderix-dashboard.html" class="active">ğŸ“Š ×œ×•×— ×‘×§×¨×”</a></li>
                    <li><a href="tenderix-dashboard.html">ğŸ“‹ ××›×¨×–×™×</a></li>
                    <li><a href="tenderix-company-profile.html">ğŸ¢ ×¤×¨×•×¤×™×œ ×—×‘×¨×”</a></li>
                    <li><a href="tenderix-analytics.html">ğŸ“ˆ ×“×•×—×•×ª</a></li>
                    <li><a href="tenderix-settings.html">âš™ï¸ ×”×’×“×¨×•×ª</a></li>
                </ul>
            </nav>
            <div class="sidebar-user" id="sidebar-user">
                <div class="user-avatar" id="user-avatar">?</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-email" id="user-email"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="dashboard-header">
                <div class="header-title">
                    <h1>×œ×•×— ×‘×§×¨×”</h1>
                    <p id="current-date"></p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="new-tender-btn">
                        â• ××›×¨×– ×—×“×©
                    </button>
                </div>
            </header>

            <!-- Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="stat-total">0</div>
                            <div class="stat-label">×¡×”"×› ××›×¨×–×™×</div>
                        </div>
                        <div class="stat-icon blue">ğŸ“‹</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="stat-active">0</div>
                            <div class="stat-label">×¤×¢×™×œ×™×</div>
                        </div>
                        <div class="stat-icon green">âœ“</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="stat-pending">0</div>
                            <div class="stat-label">×××ª×™× ×™× ×œ×”×—×œ×˜×”</div>
                        </div>
                        <div class="stat-icon yellow">â³</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="stat-value">â‚ª0</div>
                            <div class="stat-label">×©×•×•×™ ×¦×¤×™</div>
                        </div>
                        <div class="stat-icon purple">ğŸ’°</div>
                    </div>
                </div>
            </section>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Tenders List -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">××›×¨×–×™× ××—×¨×•× ×™×</h2>
                        <button class="btn btn-secondary">×”×¦×’ ×”×›×œ</button>
                    </div>
                    <div class="card-body">
                        <ul class="tender-list" id="tender-list">
                            <li class="loading"><div class="spinner"></div></li>
                        </ul>
                    </div>
                </div>

                <!-- Side Panel -->
                <div class="side-panel">
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header">
                            <h2 class="card-title">×”×¢×œ××” ××”×™×¨×”</h2>
                        </div>
                        <div class="card-body">
                            <div class="upload-zone" id="quick-upload-zone">
                                <div class="upload-zone-icon">ğŸ“„</div>
                                <div class="upload-zone-text">×’×¨×•×¨ ×§×•×‘×¥ ××›×¨×– ×œ×›××Ÿ</div>
                                <div class="upload-zone-hint">PDF, Word, Excel ×¢×“ 50MB</div>
                            </div>
                            <input type="file" id="quick-file-input" class="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h2>
                        </div>
                        <div class="card-body">
                            <ul class="activity-list" id="activity-list">
                                <li class="loading"><div class="spinner"></div></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Upload Modal -->
    <div class="modal-overlay" id="upload-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">×”×¢×œ××ª ××›×¨×– ×—×“×©</h2>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>

            <div class="upload-zone" id="modal-upload-zone">
                <div class="upload-zone-icon">ğŸ“¤</div>
                <div class="upload-zone-text">×’×¨×•×¨ ×•×©×—×¨×¨ ××¡××›×™ ××›×¨×–</div>
                <div class="upload-zone-hint">××• ×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×‘×¦×™×</div>
            </div>
            <input type="file" id="modal-file-input" class="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx" multiple>

            <div class="form-group" style="margin-top: 24px;">
                <label>×©× ×”××›×¨×– (××•×¤×¦×™×•× ×œ×™)</label>
                <input type="text" class="form-input" id="tender-name-input" placeholder="×™×–×•×”×” ××•×˜×•××˜×™×ª ××”××¡××š">
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="start-analysis-btn">
                ğŸš€ ×”×ª×—×œ × ×™×ª×•×—
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const N8N_WEBHOOK = 'https://daviderez.app.n8n.cloud/webhook';

        // PDF.js worker setup
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Use global supabase from config.js via getSupabase()
        let selectedFile = null;

        // ============================================
        // PDF TEXT EXTRACTION
        // ============================================
        async function extractTextFromPDF(file) {
            console.log('[PDF] Starting text extraction from:', file.name);

            if (typeof pdfjsLib === 'undefined') {
                console.error('[PDF] PDF.js not loaded');
                return '';
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                console.log('[PDF] Document loaded, pages:', pdf.numPages);

                let fullText = '';
                const maxPages = Math.min(pdf.numPages, 50); // Limit to 50 pages

                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n';
                }

                console.log('[PDF] Extracted', fullText.length, 'characters');
                return fullText;
            } catch (error) {
                console.error('[PDF] Extraction error:', error);
                return '';
            }
        }

        // ============================================
        // TENDER METADATA PARSING
        // ============================================
        function parseTenderMetadata(text, fileName) {
            console.log('[Parse] Parsing metadata from', text.length, 'chars');

            const parseField = (patterns) => {
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        const value = match[1].trim();
                        if (value.length > 0 && value.length < 200) return value;
                    }
                }
                return null;
            };

            const parseDate = (patterns) => {
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        // Try to parse Hebrew date format DD/MM/YYYY or DD.MM.YYYY
                        const dateStr = match[1].trim();
                        const parts = dateStr.split(/[\.\/\-]/);
                        if (parts.length >= 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1;
                            let year = parseInt(parts[2]);
                            if (year < 100) year += 2000;
                            const date = new Date(year, month, day);
                            if (!isNaN(date.getTime())) {
                                return date.toISOString();
                            }
                        }
                    }
                }
                return null;
            };

            const parseAmount = (patterns) => {
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        let value = parseFloat(match[1].replace(/,/g, ''));
                        if (text.substring(match.index, match.index + 50).includes('××™×œ×™×•×Ÿ')) {
                            value *= 1000000;
                        } else if (text.substring(match.index, match.index + 50).includes('××œ×£')) {
                            value *= 1000;
                        }
                        return value;
                    }
                }
                return null;
            };

            const metadata = {
                tender_number: parseField([
                    /××›×¨×–\s*(?:××¡['×³]?|××¡×¤×¨|×¤×•××‘×™)?\s*[:\-]?\s*([\d\/\-\.]+)/i,
                    /××¡×¤×¨\s*(?:×”)?××›×¨×–\s*[:\-]?\s*([\d\/\-\.]+)/i,
                    /××›×¨×–\s+(\d+[\d\/\-\.]*)/i,
                ]),
                tender_name: parseField([
                    /×©×\s*(?:×”)?××›×¨×–\s*[:\-]?\s*([^\n]{5,100})/i,
                    /××›×¨×–\s+(?:×œ|×”)?([^\n]{10,100})/i,
                    /× ×•×©×\s*(?:×”)?××›×¨×–\s*[:\-]?\s*([^\n]{5,100})/i,
                ]) || fileName.replace(/\.[^/.]+$/, ''),
                issuing_body: parseField([
                    /(?:×’×•×£|×’×•×¨×)\s*××–××™×Ÿ\s*[:\-]?\s*([^\n]{3,80})/i,
                    /×”××–××™×Ÿ\s*[:\-]?\s*([^\n]{3,80})/i,
                    /×¢×™×¨×™×™×ª?\s+([^\n]{3,50})/i,
                    /××©×¨×“\s+([^\n]{3,50})/i,
                    /×—×‘×¨×ª?\s+([^\n]{3,50})/i,
                ]),
                submission_deadline: parseDate([
                    /××•×¢×“\s*(?:××—×¨×•×Ÿ\s*)?(?:×œ)?×”×’×©×”?\s*[:\-]?\s*([\d]{1,2}[\.\/\-][\d]{1,2}[\.\/\-][\d]{2,4})/i,
                    /×œ×”×’×™×©\s*×¢×“\s*[:\-]?\s*([\d]{1,2}[\.\/\-][\d]{1,2}[\.\/\-][\d]{2,4})/i,
                    /×ª××¨×™×š\s*×”×’×©×”\s*[:\-]?\s*([\d]{1,2}[\.\/\-][\d]{1,2}[\.\/\-][\d]{2,4})/i,
                ]),
                clarification_deadline: parseDate([
                    /××•×¢×“\s*(?:××—×¨×•×Ÿ\s*)?(?:×œ)?(?:×©××œ×•×ª|×”×‘×”×¨×•×ª)\s*[:\-]?\s*([\d]{1,2}[\.\/\-][\d]{1,2}[\.\/\-][\d]{2,4})/i,
                    /×©××œ×•×ª\s*(?:×”×‘×”×¨×”)?\s*×¢×“\s*[:\-]?\s*([\d]{1,2}[\.\/\-][\d]{1,2}[\.\/\-][\d]{2,4})/i,
                ]),
                estimated_value: parseAmount([
                    /(?:××•××“×Ÿ|×”×™×§×£|×©×•×•×™)\s*[:\-]?\s*([\d,\.]+)/i,
                    /×ª×§×¦×™×‘\s*[:\-]?\s*([\d,\.]+)/i,
                ]),
                guarantee_amount: parseAmount([
                    /×¢×¨×‘×•×ª\s*(?:×”×¦×¢×”|×‘× ×§××™×ª)?\s*[:\-]?\s*([\d,\.]+)/i,
                    /×¡×›×•×\s*(?:×”)?×¢×¨×‘×•×ª\s*[:\-]?\s*([\d,\.]+)/i,
                ]),
            };

            console.log('[Parse] Extracted metadata:', metadata);
            return metadata;
        }

        // ============================================
        // GATE CONDITIONS EXTRACTION
        // ============================================
        async function extractGateConditions(tenderId, text) {
            console.log('[Gates] Extracting gate conditions for tender:', tenderId);

            const supabase = getSupabase();
            if (!supabase) return { success: false, count: 0 };

            const extractedConditions = [];
            let conditionNumber = 1;
            const extractedTexts = new Set();

            const gatePatterns = [
                /×ª× ××™\s*×¡×£\s*(?:××¡['×³]?|××¡×¤×¨)?\s*(\d+(?:\.\d+)?)\s*[-â€“:]\s*([^\n]+)/gi,
                /(\d+(?:\.\d+)?)\s*[.\)]\s*(?:×¢×œ\s*×”××¦×™×¢|× ×“×¨×©|×—×•×‘×”|×™×©\s*×œ×”×¦×™×’|×™×©\s*×œ×¦×¨×£)\s*([^\n]+)/gi,
                /×¢×œ\s*×”××¦×™×¢\s*(?:×œ×”×™×•×ª|×œ×”×•×›×™×—|×œ×”×¦×™×’|×œ×¦×¨×£|×œ×”××¦×™×|×œ×¢××•×“)\s*([^\n]{10,200})/gi,
                /×ª× ××™\s*×—×•×‘×”\s*[-â€“:]\s*([^\n]+)/gi,
                /×“×¨×™×©×•×ª?\s*×¡×£\s*[-â€“:]\s*([^\n]+)/gi,
            ];

            for (const pattern of gatePatterns) {
                let match;
                pattern.lastIndex = 0;
                while ((match = pattern.exec(text)) !== null) {
                    const conditionText = (match[2] || match[1]).trim();

                    if (conditionText.length < 15 || extractedTexts.has(conditionText.substring(0, 50))) {
                        continue;
                    }
                    extractedTexts.add(conditionText.substring(0, 50));

                    let requirementType = 'OTHER';
                    if (/× ×™×¡×™×•×Ÿ|×¤×¨×•×™×§×˜|×‘×™×¦×•×¢|×¢×‘×•×“×”|×©× [×”×•×ª]/.test(conditionText)) {
                        requirementType = 'EXPERIENCE';
                    } else if (/××—×–×•×¨|×”×›× ×¡×•×ª|×”×•×Ÿ|×›×¡×¤×™|×¤×™× × ×¡|×¢×¨×‘×•×ª/.test(conditionText)) {
                        requirementType = 'FINANCIAL';
                    } else if (/×ª×¢×•×“×”|×¨×™×©×™×•×Ÿ|×”×¡××›×”|ISO|×¡×™×•×•×’|××™×©×•×¨/.test(conditionText)) {
                        requirementType = 'CERTIFICATION';
                    } else if (/×× ×”×œ|×¦×•×•×ª|×¢×•×‘×“|××”× ×“×¡|×™×•×¢×¥/.test(conditionText)) {
                        requirementType = 'PERSONNEL';
                    }

                    const isMandatory = /×—×•×‘×”|×ª× ××™\s*×¡×£|×¤×•×¡×œ|×œ×”×’×™×©|× ×“×¨×©/.test(conditionText) ||
                                       /×¢×œ\s*×”××¦×™×¢/.test(match[0]);

                    extractedConditions.push({
                        tender_id: tenderId,
                        condition_number: String(conditionNumber),
                        condition_text: conditionText,
                        condition_type: 'GATE',
                        is_mandatory: isMandatory,
                        requirement_type: requirementType,
                        status: 'UNKNOWN',
                    });
                    conditionNumber++;
                }
            }

            console.log('[Gates] Found', extractedConditions.length, 'conditions');

            // Save to database
            let savedCount = 0;
            for (const condition of extractedConditions.slice(0, 30)) {
                try {
                    const { error } = await supabase
                        .from('gate_conditions')
                        .insert(condition);
                    if (!error) savedCount++;
                } catch (err) {
                    console.error('[Gates] Error saving condition:', err);
                }
            }

            console.log('[Gates] Saved', savedCount, 'conditions to database');
            return { success: savedCount > 0, count: savedCount };
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[Dashboard] Initializing...');

            // Set current date
            const dateEl = document.getElementById('current-date');
            if (dateEl) {
                const today = new Date();
                dateEl.textContent = today.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // Load user info
            await loadUserInfo();

            // Load dashboard data
            await Promise.all([
                loadStats(),
                loadTenders(),
                loadActivity()
            ]);

            // Setup event listeners
            setupEventListeners();
        });

        // ============================================
        // USER INFO
        // ============================================
        async function loadUserInfo() {
            try {
                const supabase = getSupabase();
                if (!supabase || typeof supabase.auth?.getUser !== 'function') {
                    document.getElementById('user-name').textContent = 'Guest';
                    return;
                }

                const { data: { user } } = await supabase.auth.getUser();

                if (user) {
                    const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
                    document.getElementById('user-name').textContent = name;
                    document.getElementById('user-email').textContent = user.email || '';
                    document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
                } else {
                    document.getElementById('user-name').textContent = 'Guest';
                    document.getElementById('user-email').textContent = 'Not logged in';
                }
            } catch (e) {
                console.log('Error loading user:', e);
                document.getElementById('user-name').textContent = 'Guest';
            }
        }

        // ============================================
        // LOAD STATS
        // ============================================
        async function loadStats() {
            try {
                const supabase = getSupabase();
                if (!supabase || typeof supabase.from !== 'function') {
                    console.log('[Stats] Supabase not ready');
                    setDemoStats();
                    return;
                }

                const { data: tenders, error } = await supabase
                    .from('tenders')
                    .select('*');

                if (error) {
                    console.log('[Stats] Query error:', error.message);
                    setDemoStats();
                    return;
                }

                if (!tenders || tenders.length === 0) {
                    setDemoStats();
                    return;
                }

                updateStatsFromTenders(tenders);

            } catch (e) {
                console.error('Error loading stats:', e);
                setDemoStats();
            }
        }

        function updateStatsFromTenders(tenders) {
            const stats = {
                total: tenders?.length || 0,
                active: tenders?.filter(t => ['active', 'ACTIVE', 'INTAKE', 'GATES_EXTRACTED'].includes(t.status)).length || 0,
                pending: tenders?.filter(t => ['pending', 'analyzing', 'PENDING'].includes(t.status)).length || 0,
                value: tenders?.reduce((sum, t) => sum + (t.estimated_value || 0), 0) || 0
            };

            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-active').textContent = stats.active;
            document.getElementById('stat-pending').textContent = stats.pending;
            document.getElementById('stat-value').textContent = formatCurrency(stats.value);
        }

        function setDemoStats() {
            document.getElementById('stat-total').textContent = '5';
            document.getElementById('stat-active').textContent = '3';
            document.getElementById('stat-pending').textContent = '2';
            document.getElementById('stat-value').textContent = 'â‚ª2.5M';
        }

        // ============================================
        // LOAD TENDERS
        // ============================================
        async function loadTenders() {
            const list = document.getElementById('tender-list');

            try {
                const supabase = getSupabase();
                if (!supabase || typeof supabase.from !== 'function') {
                    console.log('[Tenders] Supabase not ready');
                    showDemoTenders(list);
                    return;
                }

                const { data: tenders, error } = await supabase
                    .from('tenders')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    console.log('[Tenders] Query error:', error.message);
                    showDemoTenders(list);
                    return;
                }

                if (!tenders || tenders.length === 0) {
                    list.innerHTML = `
                        <li class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div class="empty-state-text">××™×Ÿ ××›×¨×–×™× ×¢×“×™×™×Ÿ</div>
                            <div class="empty-state-subtext">×œ×—×¥ ×¢×œ "××›×¨×– ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</div>
                            <button class="btn btn-primary" onclick="openUploadModal()" style="margin-top: 20px;">
                                â• ×”×¢×œ×” ××›×¨×–
                            </button>
                        </li>
                    `;
                    return;
                }

                renderTenders(tenders, list);

            } catch (e) {
                console.error('Error loading tenders:', e);
                showDemoTenders(list);
            }
        }

        function renderTenders(tenders, list) {
            list.innerHTML = tenders.map(tender => {
                const status = tender.status || 'draft';
                const deadline = tender.submission_deadline ? new Date(tender.submission_deadline) : null;
                const daysLeft = deadline ? Math.ceil((deadline - new Date()) / (1000*60*60*24)) : null;
                const isUrgent = daysLeft !== null && daysLeft <= 3;

                return `
                    <li class="tender-item" onclick="viewTender('${tender.id}')">
                        <div class="tender-status ${status}"></div>
                        <div class="tender-info">
                            <div class="tender-name">${tender.tender_name || tender.name || '××›×¨×– ×œ×œ× ×©×'}</div>
                            <div class="tender-meta">${tender.issuing_body || tender.organization || '×’×•×¨× ×œ× ×™×“×•×¢'}</div>
                        </div>
                        <div class="tender-value">
                            <div class="tender-amount">${formatCurrency(tender.estimated_value || 0)}</div>
                            <div class="tender-deadline ${isUrgent ? 'urgent' : ''}">
                                ${deadline ? (daysLeft > 0 ? daysLeft + ' ×™××™×' : '×¤×’ ×ª×•×§×£') : '×œ×œ× ××•×¢×“'}
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function showDemoTenders(list) {
            const demoTenders = [
                { id: '1', name: '×©×“×¨×•×’ ×ª×©×ª×™×•×ª IT', org: '××©×¨×“ ×”××•×¦×¨', value: 2500000, status: 'active', days: 5 },
                { id: '2', name: '×¤×¨×•×™×§×˜ ××¢×‘×¨ ×œ×¢× ×Ÿ', org: '×—×‘×¨×ª ×—×©××œ', value: 1800000, status: 'analyzing', days: 12 },
                { id: '3', name: '×”×ª×§× ×ª ××¢×¨×›×ª ××‘×˜×—×”', org: '×¢×™×¨×™×™×ª ×ª×œ ××‘×™×‘', value: 950000, status: 'pending', days: 2 }
            ];

            list.innerHTML = demoTenders.map(t => `
                <li class="tender-item" onclick="viewTender('${t.id}')">
                    <div class="tender-status ${t.status}"></div>
                    <div class="tender-info">
                        <div class="tender-name">${t.name}</div>
                        <div class="tender-meta">${t.org}</div>
                    </div>
                    <div class="tender-value">
                        <div class="tender-amount">${formatCurrency(t.value)}</div>
                        <div class="tender-deadline ${t.days <= 3 ? 'urgent' : ''}">${t.days} ×™××™×</div>
                    </div>
                </li>
            `).join('');
        }

        // ============================================
        // LOAD ACTIVITY
        // ============================================
        async function loadActivity() {
            const list = document.getElementById('activity-list');

            const demoActivity = [
                { icon: 'ğŸ“¤', text: '××›×¨×– ×—×“×© ×”×•×¢×œ×”', time: '×œ×¤× ×™ ×©×¢×ª×™×™×' },
                { icon: 'ğŸ”', text: '× ×™×ª×•×— ×”×•×©×œ×', time: '×œ×¤× ×™ 5 ×©×¢×•×ª' },
                { icon: 'âœ…', text: '×ª× ××™ ×¡×£ × ×‘×“×§×•', time: '××ª××•×œ' }
            ];

            list.innerHTML = demoActivity.map(a => `
                <li class="activity-item">
                    <div class="activity-icon">${a.icon}</div>
                    <div>
                        <div class="activity-text">${a.text}</div>
                        <div class="activity-time">${a.time}</div>
                    </div>
                </li>
            `).join('');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // New Tender Button
            document.getElementById('new-tender-btn').addEventListener('click', openUploadModal);

            // Modal Close
            document.getElementById('close-modal').addEventListener('click', closeUploadModal);
            document.getElementById('upload-modal').addEventListener('click', function(e) {
                if (e.target === this) closeUploadModal();
            });

            // Quick Upload Zone
            setupUploadZone('quick-upload-zone', 'quick-file-input');

            // Modal Upload Zone
            setupUploadZone('modal-upload-zone', 'modal-file-input');

            // Start Analysis Button
            document.getElementById('start-analysis-btn').addEventListener('click', startAnalysis);

            // User logout
            document.getElementById('sidebar-user').addEventListener('click', async function() {
                if (confirm('Sign out?')) {
                    const supabase = getSupabase();
                    if (supabase) {
                        await supabase.auth.signOut();
                    }
                    window.location.href = 'tenderix-login.html';
                }
            });
        }

        function setupUploadZone(zoneId, inputId) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);

            if (!zone || !input) return;

            // Click to browse
            zone.addEventListener('click', () => input.click());

            // Drag events
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0], zone);
                }
            });

            // File input change
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0], zone);
                }
            });
        }

        function handleFileSelect(file, zone) {
            selectedFile = file;

            // Update zone to show file name
            zone.innerHTML = `
                <div class="upload-zone-icon">âœ…</div>
                <div class="upload-zone-text">${file.name}</div>
                <div class="upload-zone-hint">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
            `;

            // If quick upload, open modal
            if (zone.id === 'quick-upload-zone') {
                openUploadModal();
                // Also update modal zone
                document.getElementById('modal-upload-zone').innerHTML = `
                    <div class="upload-zone-icon">âœ…</div>
                    <div class="upload-zone-text">${file.name}</div>
                    <div class="upload-zone-hint">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                `;
            }

            showToast('success', '×§×•×‘×¥ × ×‘×—×¨: ' + file.name);
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function openUploadModal() {
            document.getElementById('upload-modal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.remove('active');
        }

        // ============================================
        // UPLOAD & ANALYSIS (Direct to Supabase)
        // ============================================
        async function startAnalysis() {
            if (!selectedFile) {
                showToast('error', '× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×§×•×“×');
                return;
            }

            const supabase = getSupabase();
            if (!supabase) {
                showToast('error', '×œ× ××—×•×‘×¨ ×œ×“××˜××‘×™×™×¡');
                return;
            }

            const tenderName = document.getElementById('tender-name-input').value || selectedFile.name.replace(/\.[^/.]+$/, '');
            const zone = document.getElementById('modal-upload-zone');
            let extractedText = '';

            try {
                // Step 1: Upload file
                zone.innerHTML = `
                    <div class="upload-progress">
                        <div class="spinner"></div>
                        <p>×©×œ×‘ 1/5: ××¢×œ×” ×§×•×‘×¥...</p>
                    </div>
                `;
                console.log('[Upload] Step 1: Uploading file to storage...');

                const timestamp = Date.now();
                const fileExt = selectedFile.name.split('.').pop().toLowerCase();
                const safeFileName = `${timestamp}.${fileExt}`;
                const filePath = `tenders/${safeFileName}`;

                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('tender-documents')
                    .upload(filePath, selectedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    console.error('[Upload] Storage error:', uploadError);
                    throw new Error('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥: ' + uploadError.message);
                }

                console.log('[Upload] File uploaded:', uploadData.path);

                const { data: urlData } = supabase.storage
                    .from('tender-documents')
                    .getPublicUrl(filePath);

                const fileUrl = urlData?.publicUrl || filePath;
                console.log('[Upload] File URL:', fileUrl);

                // Step 2: Extract text from PDF
                zone.innerHTML = `
                    <div class="upload-progress">
                        <div class="spinner"></div>
                        <p>×©×œ×‘ 2/5: ××—×œ×¥ ×˜×§×¡×˜ ××”××¡××š...</p>
                    </div>
                `;
                console.log('[Upload] Step 2: Extracting text from PDF...');

                if (fileExt === 'pdf') {
                    extractedText = await extractTextFromPDF(selectedFile);
                    console.log('[Upload] Extracted', extractedText.length, 'characters');
                }

                // Step 3: Parse metadata
                zone.innerHTML = `
                    <div class="upload-progress">
                        <div class="spinner"></div>
                        <p>×©×œ×‘ 3/5: ×× ×ª×— ××˜××“××˜×”...</p>
                    </div>
                `;
                console.log('[Upload] Step 3: Parsing metadata...');

                let metadata = {};
                if (extractedText.length > 100) {
                    metadata = parseTenderMetadata(extractedText, selectedFile.name);
                }

                // Step 4: Create tender record with parsed metadata
                zone.innerHTML = `
                    <div class="upload-progress">
                        <div class="spinner"></div>
                        <p>×©×œ×‘ 4/5: ×™×•×¦×¨ ×¨×©×•××ª ××›×¨×–...</p>
                    </div>
                `;
                console.log('[Upload] Step 4: Creating tender record with metadata...');

                const tenderData = {
                    tender_name: metadata.tender_name || tenderName,
                    tender_number: metadata.tender_number || ('TDR-' + timestamp),
                    issuing_body: metadata.issuing_body || null,
                    submission_deadline: metadata.submission_deadline || null,
                    clarification_deadline: metadata.clarification_deadline || null,
                    estimated_value: metadata.estimated_value || null,
                    guarantee_amount: metadata.guarantee_amount || null,
                    status: 'INTAKE',
                    current_step: 'ANALYZING',
                    category: 'OTHER',
                    created_at: new Date().toISOString()
                };

                console.log('[Upload] Tender data:', tenderData);

                const { data: tender, error: tenderError } = await supabase
                    .from('tenders')
                    .insert(tenderData)
                    .select()
                    .single();

                if (tenderError) {
                    console.error('[Upload] Tender creation error:', tenderError);
                    throw new Error('×©×’×™××” ×‘×™×¦×™×¨×ª ××›×¨×–: ' + tenderError.message);
                }

                console.log('[Upload] Tender created:', tender.id);

                // Create document record
                const { data: doc, error: docError } = await supabase
                    .from('tender_documents')
                    .insert({
                        tender_id: tender.id,
                        file_name: selectedFile.name,
                        original_filename: selectedFile.name,
                        file_type: selectedFile.type || 'application/pdf',
                        file_size: selectedFile.size,
                        storage_path: filePath,
                        file_url: fileUrl,
                        document_type: 'TENDER_INVITATION',
                        status: 'UPLOADED',
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (docError) {
                    console.error('[Upload] Document record error:', docError);
                } else {
                    console.log('[Upload] Document record created:', doc.id);
                }

                // Step 5: Extract gate conditions
                zone.innerHTML = `
                    <div class="upload-progress">
                        <div class="spinner"></div>
                        <p>×©×œ×‘ 5/5: ×× ×ª×— ×ª× ××™ ×¡×£...</p>
                    </div>
                `;
                console.log('[Upload] Step 5: Extracting gate conditions...');

                let gatesResult = { success: false, count: 0 };
                if (extractedText.length > 100) {
                    gatesResult = await extractGateConditions(tender.id, extractedText);
                    console.log('[Upload] Gates extraction result:', gatesResult);

                    // Update tender status
                    await supabase
                        .from('tenders')
                        .update({ current_step: 'GATES_ANALYZED' })
                        .eq('id', tender.id);
                }

                // Success!
                console.log('[Upload] SUCCESS! Tender ID:', tender.id);
                const gatesMsg = gatesResult.count > 0 ? ` (${gatesResult.count} ×ª× ××™ ×¡×£ × ××¦××•)` : '';
                showToast('success', '×”××›×¨×– ×”×•×¢×œ×” ×•× ×•×ª×— ×‘×”×¦×œ×—×”!' + gatesMsg);
                closeUploadModal();

                // Refresh data
                await loadStats();
                await loadTenders();

                // Reset
                selectedFile = null;
                resetUploadZones();
                document.getElementById('tender-name-input').value = '';

                // Navigate to tender detail
                setTimeout(() => {
                    if (confirm('×”××›×¨×– × ×•×¦×¨ ×•× ×•×ª×— ×‘×”×¦×œ×—×”! ×œ×¢×‘×•×¨ ×œ×“×£ ×¤×¨×˜×™ ×”××›×¨×–?')) {
                        viewTender(tender.id);
                    }
                }, 500);

            } catch (e) {
                console.error('[Upload] Failed:', e);
                showToast('error', '×”×¢×œ××” × ×›×©×œ×”: ' + e.message);
                resetUploadZones();
            }
        }

        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove the data URL prefix (e.g., "data:application/pdf;base64,")
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        function resetUploadZones() {
            const defaultContent = `
                <div class="upload-zone-icon">ğŸ“¤</div>
                <div class="upload-zone-text">×’×¨×•×¨ ×•×©×—×¨×¨ ××¡××›×™ ××›×¨×–</div>
                <div class="upload-zone-hint">××• ×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×‘×¦×™×</div>
            `;
            document.getElementById('modal-upload-zone').innerHTML = defaultContent;
            document.getElementById('quick-upload-zone').innerHTML = `
                <div class="upload-zone-icon">ğŸ“„</div>
                <div class="upload-zone-text">×’×¨×•×¨ ×§×•×‘×¥ ××›×¨×– ×œ×›××Ÿ</div>
                <div class="upload-zone-hint">PDF, Word, Excel ×¢×“ 50MB</div>
            `;
        }

        // ============================================
        // VIEW TENDER
        // ============================================
        function viewTender(id) {
            window.location.href = `tenderix-tender-detail.html?id=${id}`;
        }

        // ============================================
        // UTILITIES
        // ============================================
        function formatCurrency(value) {
            if (value >= 1000000) {
                return 'â‚ª' + (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return 'â‚ª' + (value / 1000).toFixed(0) + 'K';
            }
            return 'â‚ª' + value.toLocaleString();
        }

        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'â„¹ï¸'}</span>
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Global functions
        window.openUploadModal = openUploadModal;
        window.viewTender = viewTender;
    </script>
</body>
</html>
